# 🔍 登录问题排查指南

## 问题现象
部署成功后网站可以访问，但用户无法登录，一直显示"登录失败"。

## 🎯 常见原因分析

### 1. 环境变量配置问题（最常见）
**症状**：登录时提示连接失败或认证错误

**解决方案**：
1. **检查Vercel环境变量设置**
   - 登录 [Vercel控制台](https://vercel.com/dashboard)
   - 进入你的项目 → Settings → Environment Variables
   - 确认以下变量已正确设置：

```
VITE_SUPABASE_URL=https://iaamsobyzdjdrgipllvi.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYW1zb2J5emRqZHJnaXBsbHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzIwNjksImV4cCI6MjA3MDkwODA2OX0.nSW8MZ5ca8x3juMk472H7aqu4eT2mEj941jK1Idqt5A
VITE_SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYW1zb2J5emRqZHJnaXBsbHZpIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTMzMjA2OSwiZXhwIjoyMDcwOTA4MDY5fQ.LhV_E8ZPjzaabqUMHBAyEnXpwyzmVARkqhV-VDAABos
```

2. **重要提醒**：
   - 确保每个环境变量都选择了 **Production**、**Preview** 和 **Development** 三个环境
   - 变量名必须完全匹配（区分大小写）
   - 变量值不能有多余的空格或引号

3. **重新部署**：
   - 添加/修改环境变量后，必须重新部署项目
   - 在Vercel控制台点击 "Redeploy" 按钮

### 2. Supabase域名配置问题
**症状**：CORS错误，浏览器控制台显示跨域请求被阻止

**解决方案**：
1. 登录 [Supabase控制台](https://supabase.com/dashboard)
2. 选择你的项目 → Authentication → URL Configuration
3. 在 **Site URL** 中添加你的Vercel部署域名：
   ```
   https://你的项目名.vercel.app
   ```
4. 在 **Redirect URLs** 中添加：
   ```
   https://你的项目名.vercel.app/**
   ```

### 3. 数据库连接问题
**症状**：登录时长时间加载，最终超时

**解决方案**：
1. 检查Supabase项目状态：
   - 确认项目没有暂停（免费版有使用限制）
   - 检查数据库是否正常运行
2. 验证数据库表结构：
   - 确认 `users` 表存在
   - 确认认证相关的表结构完整

## 🛠️ 快速诊断步骤

### 步骤1：检查浏览器控制台
1. 打开网站，按 `F12` 打开开发者工具
2. 切换到 "Console" 标签
3. 尝试登录，查看是否有错误信息
4. 常见错误类型：
   - `CORS error`：域名配置问题
   - `Invalid API key`：环境变量错误
   - `Network error`：Supabase连接问题

### 步骤2：检查网络请求
1. 在开发者工具中切换到 "Network" 标签
2. 尝试登录，查看请求状态
3. 查找发送到 `supabase.co` 的请求：
   - 状态码 `200`：请求成功
   - 状态码 `401`：认证失败
   - 状态码 `403`：权限不足
   - 状态码 `404`：API端点不存在

### 步骤3：验证环境变量
1. 在浏览器控制台输入：
   ```javascript
   console.log('SUPABASE_URL:', import.meta.env.VITE_SUPABASE_URL)
   console.log('SUPABASE_ANON_KEY:', import.meta.env.VITE_SUPABASE_ANON_KEY)
   ```
2. 检查输出是否与预期一致

## 🔧 具体修复步骤

### 修复环境变量问题
1. **删除现有的错误变量**：
   ```bash
   vercel env rm VITE_SUPABASE_URL
   vercel env rm VITE_SUPABASE_ANON_KEY
   vercel env rm VITE_SUPABASE_SERVICE_ROLE_KEY
   ```

2. **重新添加正确的变量**：
   ```bash
   vercel env add VITE_SUPABASE_URL
   # 输入：https://iaamsobyzdjdrgipllvi.supabase.co
   
   vercel env add VITE_SUPABASE_ANON_KEY
   # 输入对应的anon key
   
   vercel env add VITE_SUPABASE_SERVICE_ROLE_KEY
   # 输入对应的service role key
   ```

3. **重新部署**：
   ```bash
   vercel --prod
   ```

### 修复Supabase域名配置
1. 获取你的Vercel部署URL（如：`https://dianzicanting.vercel.app`）
2. 在Supabase控制台添加到允许的域名列表
3. 等待配置生效（通常1-2分钟）

## 📋 完整检查清单

- [ ] Vercel环境变量已正确设置
- [ ] 环境变量选择了所有环境（Production/Preview/Development）
- [ ] Supabase项目状态正常
- [ ] Supabase域名配置包含Vercel URL
- [ ] 浏览器控制台无CORS错误
- [ ] 网络请求返回正确状态码
- [ ] 数据库表结构完整
- [ ] 重新部署后测试

## 🆘 仍然无法解决？

如果按照上述步骤仍然无法解决，请提供以下信息：

1. **Vercel部署URL**：`https://你的项目名.vercel.app`
2. **浏览器控制台错误信息**：完整的错误堆栈
3. **网络请求详情**：失败请求的状态码和响应
4. **Supabase项目状态**：是否正常运行
5. **环境变量截图**：Vercel控制台的环境变量设置

## 💡 预防措施

1. **使用生产环境专用密钥**：
   - 在Supabase控制台重新生成API密钥
   - 不要在生产环境使用开发环境的密钥

2. **定期检查配置**：
   - 每次部署后验证登录功能
   - 监控Supabase使用量，避免超出限制

3. **备份重要配置**：
   - 保存环境变量配置
   - 记录Supabase项目设置

---

🎯 **大多数登录问题都是由环境变量配置不当引起的，请优先检查Vercel的环境变量设置！**