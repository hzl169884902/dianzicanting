# ç”µå­é¤åŽ…ç½‘ç«™æŠ€æœ¯æž¶æž„æ–‡æ¡£

## 1. Architecture design

```mermaid
graph TD
    A[ç”¨æˆ·æµè§ˆå™¨] --> B[Reactå‰ç«¯åº”ç”¨]
    B --> C[Supabase SDK]
    C --> D[SupabaseæœåŠ¡]
    
    subgraph "å‰ç«¯å±‚"
        B
    end
    
    subgraph "æœåŠ¡å±‚"
        D
    end
    
    subgraph "SupabaseæœåŠ¡åŒ…å«"
        F[PostgreSQLæ•°æ®åº“]
        H[å®žæ—¶è®¢é˜…]
        I[å¯¹è±¡å­˜å‚¨]
    end
    
    D --> F
    D --> H
    D --> I
```

## 2. Technology Description
- Frontend: React@18 + TypeScript + Tailwind CSS@3 + Vite + React Router
- Backend: Supabase (PostgreSQL + Storage + Realtime)
- State Management: Zustand
- UI Components: Headless UI + Heroicons
- Charts: Chart.js
- Image Processing: React Image Crop
- QR Code: qrcode-generator

## 3. Route definitions
| Route | Purpose |
|-------|----------|
| / | é¦–é¡µï¼Œå±•ç¤ºçƒ­é—¨èœå“æŽ¨èå’Œä¸»è¦åŠŸèƒ½å…¥å£ |
| /dishes | èœå“å±•ç¤ºé¡µï¼Œæµè§ˆæ‰€æœ‰èœå“å¹¶æ”¯æŒç­›é€‰æŽ’åº |
| /dishes/:id | èœå“è¯¦æƒ…é¡µï¼ŒæŸ¥çœ‹å…·ä½“èœå“ä¿¡æ¯å’Œè¥å…»æˆåˆ† |
| /records | é¥®é£Ÿè®°å½•é¡µï¼Œæ—¥åŽ†å½¢å¼ç®¡ç†ä¸ªäººé¥®é£Ÿè®°å½• |
| /recommendations | æ™ºèƒ½æŽ¨èé¡µï¼Œä¸ªæ€§åŒ–èœå“æŽ¨è |
| /social | ç¤¾äº¤äº’åŠ¨é¡µï¼ŒæŸ¥çœ‹ä»–äººåˆ†äº«å’Œäº’åŠ¨ |
| /reports | å¥åº·æŠ¥å‘Šé¡µï¼ŒæŸ¥çœ‹é¥®é£Ÿåˆ†æžæŠ¥å‘Š |
| /profile | ç”¨æˆ·ä¸­å¿ƒé¡µï¼Œä¸ªäººè®¾ç½®å’Œç›®æ ‡ç®¡ç† |


## 4. API definitions

### 4.1 èœå“ç›¸å…³

**èœå“ç›¸å…³API**
```
GET /api/dishes
```
èŽ·å–èœå“åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µå’Œç­›é€‰

Request Parameters:
| Param Name | Param Type | isRequired | Description |
|------------|------------|------------|-------------|
| page | number | false | é¡µç ï¼Œé»˜è®¤1 |
| limit | number | false | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20 |
| category | string | false | èœå“åˆ†ç±»ç­›é€‰ |
| sort | string | false | æŽ’åºæ–¹å¼(hot/rating/calories) |

Response:
| Param Name | Param Type | Description |
|------------|------------|-------------|
| dishes | array | èœå“åˆ—è¡¨ |
| total | number | æ€»æ•°é‡ |
| hasMore | boolean | æ˜¯å¦æœ‰æ›´å¤šæ•°æ® |

**é¥®é£Ÿè®°å½•API**
```
POST /api/diet-records
```
æ·»åŠ é¥®é£Ÿè®°å½•

Request:
| Param Name | Param Type | isRequired | Description |
|------------|------------|------------|-------------|
| dish_id | string | true | èœå“ID |
| date | string | true | è®°å½•æ—¥æœŸ |
| meal_type | string | true | é¤æ¬¡ç±»åž‹(breakfast/lunch/dinner/snack) |
| portion | number | false | ä»½é‡ï¼Œé»˜è®¤1 |

**æ™ºèƒ½æŽ¨èAPI**
```
GET /api/recommendations
```
èŽ·å–æ™ºèƒ½æŽ¨è

Request Parameters:
| Param Name | Param Type | isRequired | Description |
|------------|------------|------------|-------------|
| type | string | false | æŽ¨èç±»åž‹(hot/seasonal/healthy) |
| category | string | false | èœå“åˆ†ç±»ç­›é€‰ |

## 5. Data model

### 5.1 Data model definition
```mermaid
erDiagram
    DISHES ||--o{ DIET_RECORDS : recorded_in
    DISHES ||--o{ DISH_REVIEWS : reviewed_by
    DISHES ||--o{ DISH_INGREDIENTS : contains
    
    CATEGORIES ||--o{ DISHES : categorizes
    INGREDIENTS ||--o{ DISH_INGREDIENTS : used_in
    
    DISHES {
        uuid id PK
        string name
        string description
        string image_url
        uuid category_id FK
        jsonb nutrition_facts
        float avg_rating
        int review_count
        int popularity_score
        timestamp created_at
    }
    
    CATEGORIES {
        uuid id PK
        string name
        string description
        string icon
    }
    
    DIET_RECORDS {
        uuid id PK
        uuid dish_id FK
        date record_date
        string meal_type
        float portion
        timestamp created_at
    }
    
    DISH_REVIEWS {
        uuid id PK
        uuid dish_id FK
        int rating
        text comment
        string image_url
        timestamp created_at
    }
    
    INGREDIENTS {
        uuid id PK
        string name
        string unit
        jsonb nutrition_per_unit
    }
    
    DISH_INGREDIENTS {
        uuid id PK
        uuid dish_id FK
        uuid ingredient_id FK
        float quantity
    }
```

### 5.2 Data Definition Language



**èœå“åˆ†ç±»è¡¨ (categories)**
```sql
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) NOT NULL,
    description TEXT,
    icon VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆå§‹åŒ–åˆ†ç±»æ•°æ®
INSERT INTO categories (name, description, icon) VALUES
('å·èœ', 'å››å·åœ°æ–¹èœç³»ï¼Œä»¥éº»è¾£è‘—ç§°', 'ðŸŒ¶ï¸'),
('ç²¤èœ', 'å¹¿ä¸œåœ°æ–¹èœç³»ï¼Œæ¸…æ·¡é²œç¾Ž', 'ðŸ¦'),
('ç´ é£Ÿ', 'çº¯æ¤ç‰©æ€§é£Ÿæåˆ¶ä½œ', 'ðŸ¥¬'),
('å‡è„‚é¤', 'ä½Žçƒ­é‡å¥åº·é¤é£Ÿ', 'ðŸ¥—'),
('å¢žè‚Œé¤', 'é«˜è›‹ç™½è¥å…»é¤é£Ÿ', 'ðŸ¥©');

GRANT SELECT ON categories TO anon;
GRANT ALL PRIVILEGES ON categories TO authenticated;
```

**èœå“è¡¨ (dishes)**
```sql
CREATE TABLE dishes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    image_url TEXT,
    category_id UUID REFERENCES categories(id),
    nutrition_facts JSONB DEFAULT '{}',
    avg_rating DECIMAL(3,2) DEFAULT 0,
    review_count INTEGER DEFAULT 0,
    popularity_score INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_dishes_category ON dishes(category_id);
CREATE INDEX idx_dishes_rating ON dishes(avg_rating DESC);
CREATE INDEX idx_dishes_popularity ON dishes(popularity_score DESC);

GRANT SELECT ON dishes TO anon;
GRANT ALL PRIVILEGES ON dishes TO authenticated;
```

**é¥®é£Ÿè®°å½•è¡¨ (diet_records)**
```sql
CREATE TABLE diet_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    dish_id UUID REFERENCES dishes(id),
    record_date DATE NOT NULL,
    meal_type VARCHAR(20) CHECK (meal_type IN ('breakfast', 'lunch', 'dinner', 'snack')),
    portion DECIMAL(4,2) DEFAULT 1.0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_diet_records_date ON diet_records(record_date DESC);
CREATE INDEX idx_diet_records_dish ON diet_records(dish_id);

GRANT SELECT ON diet_records TO anon;
GRANT ALL PRIVILEGES ON diet_records TO authenticated;
```

**èœå“è¯„ä»·è¡¨ (dish_reviews)**
```sql
CREATE TABLE dish_reviews (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    dish_id UUID REFERENCES dishes(id),
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    image_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_dish_reviews_dish ON dish_reviews(dish_id, created_at DESC);

GRANT SELECT ON dish_reviews TO anon;
GRANT ALL PRIVILEGES ON dish_reviews TO authenticated;
```

**é£Ÿæè¡¨ (ingredients)**
```sql
CREATE TABLE ingredients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    unit VARCHAR(20) NOT NULL, -- 'g', 'ml', 'piece'
    nutrition_per_unit JSONB DEFAULT '{}', -- æ¯å•ä½è¥å…»æˆåˆ†
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

GRANT SELECT ON ingredients TO anon;
GRANT ALL PRIVILEGES ON ingredients TO authenticated;
```

**èœå“é£Ÿæå…³è”è¡¨ (dish_ingredients)**
```sql
CREATE TABLE dish_ingredients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    dish_id UUID REFERENCES dishes(id),
    ingredient_id UUID REFERENCES ingredients(id),
    quantity DECIMAL(8,2) NOT NULL, -- ç”¨é‡
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_dish_ingredients_dish ON dish_ingredients(dish_id);
CREATE INDEX idx_dish_ingredients_ingredient ON dish_ingredients(ingredient_id);

GRANT SELECT ON dish_ingredients TO anon;
GRANT ALL PRIVILEGES ON dish_ingredients TO authenticated;
```